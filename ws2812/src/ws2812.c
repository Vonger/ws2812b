#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <memory.h>

// red, green, blue is from 0~255, first is red, second is green, third is blue.
const unsigned char ws2812_map[0x300] = {
    0x92, 0x49, 0x24, 0x92, 0x49, 0x26, 0x92, 0x49, 0x34, 0x92, 0x49, 0x36, 0x92, 0x49, 0xa4, 0x92, 0x49, 0xa6, 0x92, 0x49, 0xb4, 0x92, 0x49, 0xb6,
    0x92, 0x4d, 0x24, 0x92, 0x4d, 0x26, 0x92, 0x4d, 0x34, 0x92, 0x4d, 0x36, 0x92, 0x4d, 0xa4, 0x92, 0x4d, 0xa6, 0x92, 0x4d, 0xb4, 0x92, 0x4d, 0xb6,
    0x92, 0x69, 0x24, 0x92, 0x69, 0x26, 0x92, 0x69, 0x34, 0x92, 0x69, 0x36, 0x92, 0x69, 0xa4, 0x92, 0x69, 0xa6, 0x92, 0x69, 0xb4, 0x92, 0x69, 0xb6,
    0x92, 0x6d, 0x24, 0x92, 0x6d, 0x26, 0x92, 0x6d, 0x34, 0x92, 0x6d, 0x36, 0x92, 0x6d, 0xa4, 0x92, 0x6d, 0xa6, 0x92, 0x6d, 0xb4, 0x92, 0x6d, 0xb6,
    0x93, 0x49, 0x24, 0x93, 0x49, 0x26, 0x93, 0x49, 0x34, 0x93, 0x49, 0x36, 0x93, 0x49, 0xa4, 0x93, 0x49, 0xa6, 0x93, 0x49, 0xb4, 0x93, 0x49, 0xb6,
    0x93, 0x4d, 0x24, 0x93, 0x4d, 0x26, 0x93, 0x4d, 0x34, 0x93, 0x4d, 0x36, 0x93, 0x4d, 0xa4, 0x93, 0x4d, 0xa6, 0x93, 0x4d, 0xb4, 0x93, 0x4d, 0xb6,
    0x93, 0x69, 0x24, 0x93, 0x69, 0x26, 0x93, 0x69, 0x34, 0x93, 0x69, 0x36, 0x93, 0x69, 0xa4, 0x93, 0x69, 0xa6, 0x93, 0x69, 0xb4, 0x93, 0x69, 0xb6,
    0x93, 0x6d, 0x24, 0x93, 0x6d, 0x26, 0x93, 0x6d, 0x34, 0x93, 0x6d, 0x36, 0x93, 0x6d, 0xa4, 0x93, 0x6d, 0xa6, 0x93, 0x6d, 0xb4, 0x93, 0x6d, 0xb6,
    0x9a, 0x49, 0x24, 0x9a, 0x49, 0x26, 0x9a, 0x49, 0x34, 0x9a, 0x49, 0x36, 0x9a, 0x49, 0xa4, 0x9a, 0x49, 0xa6, 0x9a, 0x49, 0xb4, 0x9a, 0x49, 0xb6,
    0x9a, 0x4d, 0x24, 0x9a, 0x4d, 0x26, 0x9a, 0x4d, 0x34, 0x9a, 0x4d, 0x36, 0x9a, 0x4d, 0xa4, 0x9a, 0x4d, 0xa6, 0x9a, 0x4d, 0xb4, 0x9a, 0x4d, 0xb6,
    0x9a, 0x69, 0x24, 0x9a, 0x69, 0x26, 0x9a, 0x69, 0x34, 0x9a, 0x69, 0x36, 0x9a, 0x69, 0xa4, 0x9a, 0x69, 0xa6, 0x9a, 0x69, 0xb4, 0x9a, 0x69, 0xb6,
    0x9a, 0x6d, 0x24, 0x9a, 0x6d, 0x26, 0x9a, 0x6d, 0x34, 0x9a, 0x6d, 0x36, 0x9a, 0x6d, 0xa4, 0x9a, 0x6d, 0xa6, 0x9a, 0x6d, 0xb4, 0x9a, 0x6d, 0xb6,
    0x9b, 0x49, 0x24, 0x9b, 0x49, 0x26, 0x9b, 0x49, 0x34, 0x9b, 0x49, 0x36, 0x9b, 0x49, 0xa4, 0x9b, 0x49, 0xa6, 0x9b, 0x49, 0xb4, 0x9b, 0x49, 0xb6,
    0x9b, 0x4d, 0x24, 0x9b, 0x4d, 0x26, 0x9b, 0x4d, 0x34, 0x9b, 0x4d, 0x36, 0x9b, 0x4d, 0xa4, 0x9b, 0x4d, 0xa6, 0x9b, 0x4d, 0xb4, 0x9b, 0x4d, 0xb6,
    0x9b, 0x69, 0x24, 0x9b, 0x69, 0x26, 0x9b, 0x69, 0x34, 0x9b, 0x69, 0x36, 0x9b, 0x69, 0xa4, 0x9b, 0x69, 0xa6, 0x9b, 0x69, 0xb4, 0x9b, 0x69, 0xb6,
    0x9b, 0x6d, 0x24, 0x9b, 0x6d, 0x26, 0x9b, 0x6d, 0x34, 0x9b, 0x6d, 0x36, 0x9b, 0x6d, 0xa4, 0x9b, 0x6d, 0xa6, 0x9b, 0x6d, 0xb4, 0x9b, 0x6d, 0xb6,
    0xd2, 0x49, 0x24, 0xd2, 0x49, 0x26, 0xd2, 0x49, 0x34, 0xd2, 0x49, 0x36, 0xd2, 0x49, 0xa4, 0xd2, 0x49, 0xa6, 0xd2, 0x49, 0xb4, 0xd2, 0x49, 0xb6,
    0xd2, 0x4d, 0x24, 0xd2, 0x4d, 0x26, 0xd2, 0x4d, 0x34, 0xd2, 0x4d, 0x36, 0xd2, 0x4d, 0xa4, 0xd2, 0x4d, 0xa6, 0xd2, 0x4d, 0xb4, 0xd2, 0x4d, 0xb6,
    0xd2, 0x69, 0x24, 0xd2, 0x69, 0x26, 0xd2, 0x69, 0x34, 0xd2, 0x69, 0x36, 0xd2, 0x69, 0xa4, 0xd2, 0x69, 0xa6, 0xd2, 0x69, 0xb4, 0xd2, 0x69, 0xb6,
    0xd2, 0x6d, 0x24, 0xd2, 0x6d, 0x26, 0xd2, 0x6d, 0x34, 0xd2, 0x6d, 0x36, 0xd2, 0x6d, 0xa4, 0xd2, 0x6d, 0xa6, 0xd2, 0x6d, 0xb4, 0xd2, 0x6d, 0xb6,
    0xd3, 0x49, 0x24, 0xd3, 0x49, 0x26, 0xd3, 0x49, 0x34, 0xd3, 0x49, 0x36, 0xd3, 0x49, 0xa4, 0xd3, 0x49, 0xa6, 0xd3, 0x49, 0xb4, 0xd3, 0x49, 0xb6,
    0xd3, 0x4d, 0x24, 0xd3, 0x4d, 0x26, 0xd3, 0x4d, 0x34, 0xd3, 0x4d, 0x36, 0xd3, 0x4d, 0xa4, 0xd3, 0x4d, 0xa6, 0xd3, 0x4d, 0xb4, 0xd3, 0x4d, 0xb6,
    0xd3, 0x69, 0x24, 0xd3, 0x69, 0x26, 0xd3, 0x69, 0x34, 0xd3, 0x69, 0x36, 0xd3, 0x69, 0xa4, 0xd3, 0x69, 0xa6, 0xd3, 0x69, 0xb4, 0xd3, 0x69, 0xb6,
    0xd3, 0x6d, 0x24, 0xd3, 0x6d, 0x26, 0xd3, 0x6d, 0x34, 0xd3, 0x6d, 0x36, 0xd3, 0x6d, 0xa4, 0xd3, 0x6d, 0xa6, 0xd3, 0x6d, 0xb4, 0xd3, 0x6d, 0xb6,
    0xda, 0x49, 0x24, 0xda, 0x49, 0x26, 0xda, 0x49, 0x34, 0xda, 0x49, 0x36, 0xda, 0x49, 0xa4, 0xda, 0x49, 0xa6, 0xda, 0x49, 0xb4, 0xda, 0x49, 0xb6,
    0xda, 0x4d, 0x24, 0xda, 0x4d, 0x26, 0xda, 0x4d, 0x34, 0xda, 0x4d, 0x36, 0xda, 0x4d, 0xa4, 0xda, 0x4d, 0xa6, 0xda, 0x4d, 0xb4, 0xda, 0x4d, 0xb6,
    0xda, 0x69, 0x24, 0xda, 0x69, 0x26, 0xda, 0x69, 0x34, 0xda, 0x69, 0x36, 0xda, 0x69, 0xa4, 0xda, 0x69, 0xa6, 0xda, 0x69, 0xb4, 0xda, 0x69, 0xb6,
    0xda, 0x6d, 0x24, 0xda, 0x6d, 0x26, 0xda, 0x6d, 0x34, 0xda, 0x6d, 0x36, 0xda, 0x6d, 0xa4, 0xda, 0x6d, 0xa6, 0xda, 0x6d, 0xb4, 0xda, 0x6d, 0xb6,
    0xdb, 0x49, 0x24, 0xdb, 0x49, 0x26, 0xdb, 0x49, 0x34, 0xdb, 0x49, 0x36, 0xdb, 0x49, 0xa4, 0xdb, 0x49, 0xa6, 0xdb, 0x49, 0xb4, 0xdb, 0x49, 0xb6,
    0xdb, 0x4d, 0x24, 0xdb, 0x4d, 0x26, 0xdb, 0x4d, 0x34, 0xdb, 0x4d, 0x36, 0xdb, 0x4d, 0xa4, 0xdb, 0x4d, 0xa6, 0xdb, 0x4d, 0xb4, 0xdb, 0x4d, 0xb6,
    0xdb, 0x69, 0x24, 0xdb, 0x69, 0x26, 0xdb, 0x69, 0x34, 0xdb, 0x69, 0x36, 0xdb, 0x69, 0xa4, 0xdb, 0x69, 0xa6, 0xdb, 0x69, 0xb4, 0xdb, 0x69, 0xb6,
    0xdb, 0x6d, 0x24, 0xdb, 0x6d, 0x26, 0xdb, 0x6d, 0x34, 0xdb, 0x6d, 0x36, 0xdb, 0x6d, 0xa4, 0xdb, 0x6d, 0xa6, 0xdb, 0x6d, 0xb4, 0xdb, 0x6d, 0xb6,
};

// ws2812 max led driver is 1024, one led will need 3bits x 24bit = 9byte.
#define WS2812_MAX_LED				1024
#define WS2812_COLOR_R(rgb)			((unsigned char)((rgb) >> 16))
#define WS2812_COLOR_G(rgb)			((unsigned char)((rgb) >>  8))
#define WS2812_COLOR_B(rgb)			((unsigned char)((rgb)      ))

#define WS2812_COLOR_BYTE1(q)		(ws2812_map[(q) * 3    ])
#define WS2812_COLOR_BYTE2(q)		(ws2812_map[(q) * 3 + 1])
#define WS2812_COLOR_BYTE3(q)		(ws2812_map[(q) * 3 + 2])

unsigned char ws2812_data[WS2812_MAX_LED * 9] = {0};

void ws2812_update(int size)
{
    int count = ((size * 9 + 3) >> 2) << 2; // align count to 4 bytes.
#ifdef WS2812_DEBUG
    int i;
    for (i = 0; i < count; i++) {
        if (i && (i % 12 == 0))
            printf("\n");
        printf("%02X ", ws2812_data[i]);
	}
#else
	FILE *fp = fopen("/sys/devices/10000000.palmbus/10002800.gdma/update", "w");
    if (fp == NULL)
        return;
    fwrite(ws2812_data, 1, count, fp);
    fclose(fp);
#endif
}

void ws2812_push(unsigned char q, int count)
{
	unsigned char b1 = WS2812_COLOR_BYTE1(q);
	unsigned char b2 = WS2812_COLOR_BYTE2(q);
	unsigned char b3 = WS2812_COLOR_BYTE3(q);

	switch (count % 4) {
	case 0:
		ws2812_data[count + 3] = b1;
		ws2812_data[count + 2] = b2;
		ws2812_data[count + 1] = b3;
		break;
	case 1:
        ws2812_data[count + 1] = b1;
        ws2812_data[count    ] = b2;
        ws2812_data[count - 1] = b3;
        break;
	case 2:
        ws2812_data[count - 1] = b1;
        ws2812_data[count - 2] = b2;
        ws2812_data[count + 5] = b3;
		break;
	case 3:
        ws2812_data[count - 3] = b1;
        ws2812_data[count + 4] = b2;
        ws2812_data[count + 3] = b3;
		break;
	}
}

void ws2812_set(int *color, int size)
{
	int c = 0, i;
	for (i = 0; i < size; i++) {
		unsigned char r = WS2812_COLOR_R(color[i]);
		unsigned char g = WS2812_COLOR_G(color[i]);
		unsigned char b = WS2812_COLOR_B(color[i]);

        // ws2812 pixel order is GRB.
        ws2812_push(g, c); c += 3;
		ws2812_push(r, c); c += 3;
		ws2812_push(b, c); c += 3;
	}
	ws2812_update(size);
}

void ws2812_reset()
{
    int colors[WS2812_MAX_LED] = {0};
    ws2812_set(colors, WS2812_MAX_LED);
}

#ifdef WS2812_GENERATE_MAP
void ws2812_generate_map()
{
    int i;
    for (i = 0; i < 0x100; i++) {
        int j, out = 0;

        // in ws2812, 0 is 100b(4), 1 is 110b(6).
        for (j = 0; j < 8; j++) {
            out = out << 3;
            if (i >> (7 - j) & 0x1)
                out |= 6;
            else
                out |= 4;
        }

        if (i && (i % 8 == 0))
            printf("\n");

        printf("0x%02x, 0x%02x, 0x%02x, ",
            WS2812_COLOR_R(out), WS2812_COLOR_G(out), WS2812_COLOR_B(out));
    }
}
#endif

#ifdef WS2812_UNIT_TEST
int main(int argc, char *argv[])
{
	if (argc == 1) {
        // 16 WS2812B LEDs, show them in different color.
		int color[] = {0x080000, 0x000800, 0x000008,
		               0x080000, 0x000800, 0x000008,
		               0x080000, 0x000800, 0x000008,
		               0x080000, 0x000800, 0x000008,
		               0x080000, 0x000800, 0x000008,
		               0x080000,
		              };
		ws2812_set(color, sizeof(color) / sizeof(int));
		sleep(1);
		ws2812_reset();
	} else if (strcmp(argv[1], "reset") == 0) {
		ws2812_reset();
	} else {
		int size, *color;

		printf("usage: ws2812 [index] [red: 0~255] [green: 0~255] [blue: 0~255]\n"
            "example, light the sixth LED, set its color to RGB(22,0,80): ws2812 5 22 0 80\n");

		size = atoi(argv[1]) + 1;
		color = (int *)malloc(sizeof(int) * size);
		bzero(color, sizeof(int) * size);

		color[size - 1] = ((atoi(argv[2]) & 0xff) << 16) | ((atoi(argv[3]) & 0xff) << 8) | (atoi(argv[4]) & 0xff);
		ws2812_set(color, size);
	}

	return 0;
}
#endif
